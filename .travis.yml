dist: bionic
git:
  depth: false
language: go
go:
  - 1.18.x
env:
  global:
  - CGO_ENABLED=0
  - GO111MODULE=on
  - PLATFORMS="linux/arm64 linux/amd64"
go_import_path: github.com/adevinta/vulcan-checks
deploy:
  - provider: script
    script: bash release-multi.sh
    on:
      all_branches: true
  - provider: script
    script: bash release-multi.sh
    on:
      tags: true
  - provider: script
    script: >-
      mkdir pages/checktypes &&
      go install "github.com/adevinta/vulcan-check-catalog/cmd/vulcan-check-catalog@${VCC_VERSION:-main}" &&
      vulcan-check-catalog -registry-url "$DKR_USERNAME" -tag edge -output pages/checktypes/edge.json cmd/
    on:
      branch: master
  - provider: pages
    # This process overwrites all the files in gh-pages with ./pages, so it only works with master.
    # If we need to publish more checktypes we would have to refactor this process or migrate to peaceiris/actions-gh-pages@v3
    skip_cleanup: true
    github_token: $GITHUB_TOKEN
    keep_history: true
    local_dir: ./pages
    on:
      branch: master
