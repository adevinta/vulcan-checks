dist: bionic
git:
  depth: false
language: go
go:
  - 1.19.x
env:
  global:
  - PLATFORMS="linux/amd64 linux/arm64"
  - ARM64_EXCLUDE="(prowler|semgrep|zap)"   # Regex with the check names to exclude from arm64 build
go_import_path: github.com/adevinta/vulcan-checks
before_deploy: 
  - sudo mkdir -m 0755 -p /etc/apt/keyrings && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
  - sudo apt-get update && sudo apt-get install docker-buildx-plugin
deploy:
  - provider: script
    script: bash release.sh
    on:
      all_branches: true
  - provider: script
    script: bash release.sh
    on:
      tags: true
  - provider: script
    script: bash release-check-catalog.sh
    on:
      branch: master
  - provider: pages
    # This process overwrites all the files in gh-pages with ./pages, so it only works with master.
    # If we need to publish more checktypes we would have to refactor this process or migrate to peaceiris/actions-gh-pages@v3
    # Or update release-check-catalog.sh to get pages/checktypes from gh-pages
    skip_cleanup: true
    github_token: $GITHUB_TOKEN
    keep_history: true
    local_dir: ./pages
    on:
      branch: master
